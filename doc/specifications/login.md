# JESGO ログイン・認証関連仕様

## 概要

JESGO のログイン・認証関連仕様について、仕様を記載する。
主な機能は以下。

- JWT 発行機能
- JWT 検証機能

## 画面仕様

### 1.ログイン画面

#### 概要

- ユーザ名とパスワードを入力しログインを行う。

#### 詳細仕様

- ユーザ名

  - ユーザ名を入力する。

- パスワード

  - パスワードを入力する。

- ログインボタン
  - 押下時、入力されているユーザ名とパスワードをログイン用 API に POST する。

### 2.患者一覧画面

#### 概要

- 表示、各種検索時に認証を行う。

#### 詳細仕様

- 表示権限確認
  - 同ページ表示時、検索時に API を投げる際、同時に JWT による認証を必要とする。
    - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`VIEW`の権限があることを確認してから結果を返す。
    - 同時に`ADD`,`EDIT`,`DELETE`、の権限も確認し、必要に応じて画面表示を一部切り替える。

### 3.患者情報、症例入力・編集画面

#### 概要

- 患者情報、症例の新規作成、編集を行う。
- 編集画面においてもドキュメントの新規追加はできるため、API 使用時に新規作成、編集の区別はつけないものとする。
  - ただし、編集権限がないユーザの場合、既存の患者情報に編集ボタンは表示させないものとする。

#### 詳細仕様

- 同ページからの入力データ POST 時に API を投げる際、同時に JWT による認証を必要とする。
  - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`ADD`の権限があることを確認してから API を実行する。
    - 表示時に`ADD`の権限がない場合、ログイン画面へリダイレクトする。

### 4.利用者管理画面

#### 概要

- 利用者(ログインユーザ)の一覧表示、新規作成、編集、削除を行う。

#### 詳細仕様

- 同ページからの POST 時に API を投げる際、同時に JWT による認証を必要とする。
  - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`SYSTEM_MANAGE`の権限があることを確認してから API を実行する。

### 5.設定画面

#### 概要

- 設定の表示、変更を行う。

#### 詳細仕様

- 同ページからの POST 時に API を投げる際、同時に JWT による認証を必要とする。
  - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`SYSTEM_MANAGE`の権限があることを確認してから API を実行する。

### 6.スキーマ管理画面

#### 概要

- スキーマの表示、編集、アップロードを行う。

#### 詳細仕様

- 同ページからの POST 時に API を投げる際、同時に JWT による認証を必要とする。
  - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`SYSTEM_MANAGE`の権限があることを確認してから API を実行する。

## 認証機構仕様

### 概要

本プロジェクトはフロントエンドに React、バックエンドに API 群を使用したサーバレス相当モデルでの運用を行うため、セッションは利用しない。
したがってセッションを利用しないユーザログイン状態管理として JWT を使用することとする。

### 形式

JWT による認証は一般的には通常認証を行うために仕様する認証トークンと、認証トークンの期限切れ時に再度認証を行うためのリフレッシュトークンを使用する。
本システムにおいても同様の管理方法とし、認証トークンより期限が長いリフレッシュトークンをトークン発行時に認証トークンと共に返すものとする。
通常の認証を伴う API の使用にはすべて認証トークンを付与してのアクセスを行う。サーバ側で期限切れが検出された場合、その旨をウェブアプリ側に返し、
ウェブアプリ側はリフレッシュトークンを用いて再認証を行い、再取得した認証トークンで再びもともとの API 通信を行う。
その際、リフレッシュトークンを用いた再認証でも期限切れが検出された場合は再アクセスを行わずログインページへ戻るものとする。

### 内容

JWT にはペイロードとしてユーザ ID(システム上の連番)、ユーザ名(ログインに使用する文字列)、ユーザ表示名、権限等を含み、可用時間を 1 時間として設定する。
リフレッシュトークンには同様の情報と、可用時間を 3 時間として設定する。

### 発行手順

JWT の発行にはユーザ名とパスワードを入力として以下の手順で行う。

1. 予めデータベースにログイン用のユーザとしてユーザ情報を登録しておく。その際は平文のパスワードに、環境によって指定されているパスワードソルトを追加したものをハッシュ化して保存する。
1. ログイン用に POST されたユーザ名から DB を検索し、保存されたパスワードハッシュを含む情報を取得する。
1. 上記のパスワードハッシュとログイン用に POST されたパスワードを同一手順でハッシュ化したものが同等かを確認する。
1. 同等であった場合、取得した情報のうちペイロードに使用するものを取り出し、環境に設定されている暗号鍵を用いて JWT 化し、発行する。
1. リフレッシュトークンにも同様のペイロードを使用し、環境に設定されている暗号鍵に特定の文字列を追加したもので JWT 化し、発行する。

### 認証手順

API 使用時には発行済のをヘッダに載せてアクセスを行い、該当の JWT が期限内且つ正常にデコードできるものであれば登録されているユーザ ID のユーザでログインしているものとして扱う。
使用する API がリフレッシュトークン認証用の物であった場合、リフレッシュトークン用のデコードを行い、同様に期限内であるかを確認する。
