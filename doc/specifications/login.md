# JESGO ログイン・認証関連仕様

## 概要

JESGO のログイン・認証関連仕様について、仕様案を記載する。
主な機能は以下。

- JWT 発行機能
- JWT 検証機能

## 画面仕様

### 1.ログイン画面

#### 概要

- ユーザ名とパスワードを入力しログインを行う。

#### 詳細仕様

- ユーザ名

  - ユーザ名を入力する。

- パスワード

  - パスワードを入力する。

- ログインボタン
  - 押下時、入力されているユーザ名とパスワードをログイン用 API に POST する。

### 2.患者一覧画面

#### 概要

- 表示、各種検索時に認証を行う。

#### 詳細仕様

- 表示権限確認
  - 同ページ表示時、検索時に API を投げる際、同時に JWT による認証を必要とする。
    - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`VIEW`の権限があることを確認してから結果を返す。
    - 同時に`ADD`,`EDIT`の権限も確認し、必要に応じて画面表示を一部切り替える。

### 3.患者情報、症例入力・編集画面

#### 概要

- 患者情報、症例の新規作成、編集を行う。
- 呼び元により表示内容を切り替える。
  - 以下、新規作成から呼ばれた場合を「新規作成」、編集から呼ばれた場合を「編集」とする

#### 詳細仕様

- 新規作成

  - 新規作成としての同ページ表示時、同ページからの入力データ POST 時に API を投げる際、同時に JWT による認証を必要とする。
    - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`ADD`の権限があることを確認してから API を実行する。
      - 表示時に`ADD`の権限がない場合、ログイン画面へリダイレクトする。

- 編集
  - 新規作成としての同ページ表示時、同ページからの入力データ POST 時に API を投げる際、同時に JWT による認証を必要とする。
    - JWT に含まれるからユーザ ID から DB を検索し、ログイン中のユーザに`EDIT`の権限があることを確認してから API を実行する。
      - 表示時に`EDIT`の権限がない場合、読込専用の状態で表示を行う。

### 4.ユーザ一覧画面

#### 概要

- β 版での実装は行わない。

## 認証機構仕様

### 概要

本プロジェクトはフロントエンドに React、バックエンドに API 群を使用したサーバレス相当モデルでの運用を行うため、セッションは利用しない。
したがってセッションを利用しないユーザログイン状態管理として JWT を使用することとする。

### 形式

JWT による認証は一般的には通常認証を行うために仕様する認証トークンと、認証トークンの期限切れ時に再度認証を行うためのリフレッシュトークンを使用する。
本システムはイントラネット上ので使用を前提とするため、外部からの攻撃はないものとし、認証トークンのみでの認証運用を行う。

### 内容

JWT にはペイロードとしてユーザ ID(システム上の連番)、ユーザ名(ログインに使用する文字列)、ユーザ表示名を含み、可用時間を 1 時間として設定する。

### 発行手順

JWT の発行にはユーザ名とパスワードを入力として以下の手順で行う。

1. 予めデータベースにログイン用のユーザとしてユーザ情報を登録しておく。その際は平文のパスワードに、環境によって指定されているパスワードソルトを追加したものをハッシュ化して保存する。
1. ログイン用に POST されたユーザ名から DB を検索し、保存されたパスワードハッシュを含む情報を取得する。
1. 上記のパスワードハッシュとログイン用に POST されたパスワードを同一手順でハッシュ化したものが同等かを確認する。
1. 同等であった場合、取得した情報のうちペイロードに使用するものを取り出し、環境に設定されている暗号鍵を用いて JWT 化し、発行する。

### 認証手順

API 使用時には発行済のをヘッダに載せてアクセスを行い、該当の JWT が期限内且つ正常にデコードできるものであれば登録されているユーザ ID のユーザでログインしているものとして扱う。
